{% extends 'base.html' %}

{% block title %}{{ title }} - AdminiRed{% endblock %}

{% block extra_css %}
<style>
    /* Estilos del buscador de clientes */
    .cliente-search-container {
        position: relative;
    }
    
    .cliente-search-input {
        width: 100%;
        padding: 0.75rem;
        padding-left: 2.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .cliente-search-input:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .cliente-search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }
    
    .cliente-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        display: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .cliente-results.active {
        display: block;
    }
    
    .cliente-result-item {
        padding: 0.75rem 1rem;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
    }
    
    .cliente-result-item:last-child {
        border-bottom: none;
    }
    
    .cliente-result-item:hover,
    .cliente-result-item.selected {
        background-color: #f0f4ff;
    }
    
    .cliente-result-name {
        font-weight: 600;
        color: #111827;
    }
    
    .cliente-result-info {
        font-size: 0.85rem;
        color: #6b7280;
        margin-top: 0.25rem;
    }
    
    .cliente-result-badge {
        display: inline-block;
        padding: 0.15rem 0.5rem;
        border-radius: 4px;
        font-size: 0.75rem;
        font-weight: 600;
        margin-left: 0.5rem;
    }
    
    .badge-activo {
        background: #d1fae5;
        color: #065f46;
    }
    
    .badge-inactivo {
        background: #e5e7eb;
        color: #6b7280;
    }
    
    .badge-suspendido {
        background: #fef3c7;
        color: #92400e;
    }
    
    .cliente-selected-card {
        background: linear-gradient(135deg, #f0f4ff 0%, #e8ecff 100%);
        border: 2px solid #667eea;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 0.5rem;
        display: none;
    }
    
    .cliente-selected-card.active {
        display: block;
    }
    
    .cliente-selected-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 0.5rem;
    }
    
    .cliente-selected-name {
        font-weight: 700;
        color: #667eea;
        font-size: 1.1rem;
    }
    
    .cliente-selected-remove {
        background: none;
        border: none;
        color: #ef4444;
        cursor: pointer;
        padding: 0.25rem 0.5rem;
        border-radius: 4px;
        font-size: 0.875rem;
        transition: background-color 0.2s;
    }
    
    .cliente-selected-remove:hover {
        background: #fee2e2;
    }
    
    .cliente-selected-details {
        font-size: 0.9rem;
        color: #374151;
    }
    
    .instalaciones-previas {
        background: #f9fafb;
        border: 1px solid #e5e7eb;
        border-radius: 8px;
        padding: 1rem;
        margin-top: 1rem;
        display: none;
    }
    
    .instalaciones-previas.active {
        display: block;
    }
    
    .instalaciones-previas-title {
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.75rem;
        font-size: 0.9rem;
    }
    
    .instalacion-previa-item {
        padding: 0.75rem;
        background: white;
        border: 1px solid #e5e7eb;
        border-radius: 6px;
        margin-bottom: 0.5rem;
        font-size: 0.875rem;
    }
    
    .instalacion-previa-item:last-child {
        margin-bottom: 0;
    }
    
    .instalacion-previa-plan {
        font-weight: 600;
        color: #111827;
    }
    
    .instalacion-previa-info {
        color: #6b7280;
        font-size: 0.8rem;
        margin-top: 0.25rem;
    }
    
    .no-results {
        padding: 1rem;
        text-align: center;
        color: #6b7280;
    }
    
    .searching {
        padding: 1rem;
        text-align: center;
        color: #667eea;
    }
    
    @media (max-width: 768px) {
        .cliente-results {
            max-height: 250px;
        }
        
        .cliente-result-item {
            padding: 0.65rem 0.75rem;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
        <h2>{{ title }}</h2>
        <a href="{% if instalacion %}{% url 'instalaciones:instalacion_detail' instalacion.pk %}{% else %}{% url 'instalaciones:instalacion_list' %}{% endif %}" class="btn btn-secondary"><i class="fas fa-arrow-left"></i> Volver</a>
    </div>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    <form method="post" id="instalacion-form">
        {% csrf_token %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <!-- Información Básica -->
            <div class="form-group" style="grid-column: 1 / -1;">
                <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem;">
                    <i class="fas fa-info-circle"></i> Información Básica
                </h3>
            </div>
            
            <!-- Buscador de Cliente -->
            <div class="form-group" style="grid-column: 1 / -1;">
                <label><i class="fas fa-user"></i> Cliente *</label>
                
                <!-- Campo oculto para el ID del cliente -->
                <input type="hidden" name="cliente" id="id_cliente" value="{% if cliente_pre_seleccionado %}{{ cliente_pre_seleccionado.pk }}{% elif form.cliente.value %}{{ form.cliente.value }}{% endif %}">
                
                <!-- Buscador -->
                <div class="cliente-search-container" id="clienteSearchContainer">
                    <i class="fas fa-search cliente-search-icon"></i>
                    <input 
                        type="text" 
                        class="cliente-search-input" 
                        id="clienteSearchInput"
                        placeholder="Buscar cliente por nombre, teléfono o email..."
                        autocomplete="off"
                        {% if cliente_pre_seleccionado or form.cliente.value %}style="display: none;"{% endif %}
                    >
                    <div class="cliente-results" id="clienteResults"></div>
                </div>
                
                <!-- Card del cliente seleccionado -->
                <div class="cliente-selected-card {% if cliente_pre_seleccionado or form.cliente.value %}active{% endif %}" id="clienteSelectedCard">
                    <div class="cliente-selected-header">
                        <span class="cliente-selected-name" id="clienteSelectedName">
                            {% if cliente_pre_seleccionado %}
                                {{ cliente_pre_seleccionado.nombre_completo }}
                            {% elif instalacion and instalacion.cliente %}
                                {{ instalacion.cliente.nombre_completo }}
                            {% endif %}
                        </span>
                        <button type="button" class="cliente-selected-remove" onclick="removeSelectedCliente()">
                            <i class="fas fa-times"></i> Cambiar
                        </button>
                    </div>
                    <div class="cliente-selected-details" id="clienteSelectedDetails">
                        {% if cliente_pre_seleccionado %}
                            <i class="fas fa-phone"></i> {{ cliente_pre_seleccionado.telefono }}
                            {% if cliente_pre_seleccionado.email %}
                                &nbsp;|&nbsp; <i class="fas fa-envelope"></i> {{ cliente_pre_seleccionado.email }}
                            {% endif %}
                        {% elif instalacion and instalacion.cliente %}
                            <i class="fas fa-phone"></i> {{ instalacion.cliente.telefono }}
                            {% if instalacion.cliente.email %}
                                &nbsp;|&nbsp; <i class="fas fa-envelope"></i> {{ instalacion.cliente.email }}
                            {% endif %}
                        {% endif %}
                    </div>
                </div>
                
                <!-- Instalaciones previas del cliente -->
                <div class="instalaciones-previas" id="instalacionesPrevias">
                    <div class="instalaciones-previas-title">
                        <i class="fas fa-list"></i> Instalaciones previas de este cliente:
                    </div>
                    <div id="instalacionesPreviasList"></div>
                </div>
                
                {% if form.cliente.errors %}
                    <div style="color: #ef4444; font-size: 0.875rem; margin-top: 0.25rem;">{{ form.cliente.errors }}</div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.tipo_instalacion.id_for_label }}">{{ form.tipo_instalacion.label }} (opcional)</label>
                {{ form.tipo_instalacion }}
                {% if form.tipo_instalacion.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.tipo_instalacion.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.numero_contrato.id_for_label }}">
                    {{ form.numero_contrato.label }}
                    <small style="color: #6b7280; font-weight: normal;">(Se genera automáticamente si se deja vacío)</small>
                </label>
                {{ form.numero_contrato }}
                {% if form.numero_contrato.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.numero_contrato.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.estado.id_for_label }}">{{ form.estado.label }} *</label>
                {{ form.estado }}
                {% if form.estado.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.estado.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.direccion_instalacion.id_for_label }}">{{ form.direccion_instalacion.label }} *</label>
                {{ form.direccion_instalacion }}
                {% if form.direccion_instalacion.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.direccion_instalacion.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.coordenadas.id_for_label }}">{{ form.coordenadas.label }} (opcional)</label>
                {{ form.coordenadas }}
                {% if form.coordenadas.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.coordenadas.errors }}
                    </div>
                {% endif %}
                {% if form.coordenadas.help_text %}
                    <small style="color: #6b7280; font-size: 0.875rem;">{{ form.coordenadas.help_text }}</small>
                {% endif %}
            </div>
            
            <!-- Plan y Velocidad -->
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 1rem;">
                <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem;">
                    <i class="fas fa-tachometer-alt"></i> Plan y Velocidad
                </h3>
            </div>
            
            <div class="form-group">
                <label for="{{ form.plan.id_for_label }}">{{ form.plan.label }} (opcional)</label>
                {{ form.plan }}
                {% if form.plan.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.plan.errors }}
                    </div>
                {% endif %}
                <small style="color: #6b7280; font-size: 0.875rem; display: block; margin-top: 0.5rem;">
                    <i class="fas fa-info-circle"></i> Selecciona un plan del catálogo para llenar automáticamente los campos, o completa manualmente
                </small>
            </div>
            
            <div class="form-group">
                <label for="{{ form.plan_nombre.id_for_label }}">{{ form.plan_nombre.label }} *</label>
                {{ form.plan_nombre }}
                {% if form.plan_nombre.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.plan_nombre.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.velocidad_descarga.id_for_label }}">{{ form.velocidad_descarga.label }} *</label>
                {{ form.velocidad_descarga }}
                {% if form.velocidad_descarga.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.velocidad_descarga.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.velocidad_subida.id_for_label }}">{{ form.velocidad_subida.label }} (opcional)</label>
                {{ form.velocidad_subida }}
                {% if form.velocidad_subida.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.velocidad_subida.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.precio_mensual.id_for_label }}">{{ form.precio_mensual.label }} *</label>
                {{ form.precio_mensual }}
                {% if form.precio_mensual.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.precio_mensual.errors }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Fechas -->
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 1rem;">
                <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem;">
                    <i class="fas fa-calendar-alt"></i> Fechas
                </h3>
            </div>
            
            <div class="form-group">
                <label for="{{ form.fecha_programada.id_for_label }}">{{ form.fecha_programada.label }} (opcional)</label>
                {{ form.fecha_programada }}
                {% if form.fecha_programada.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.fecha_programada.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.fecha_instalacion.id_for_label }}">{{ form.fecha_instalacion.label }} (opcional)</label>
                {{ form.fecha_instalacion }}
                {% if form.fecha_instalacion.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.fecha_instalacion.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.fecha_activacion.id_for_label }}">{{ form.fecha_activacion.label }} (opcional)</label>
                {{ form.fecha_activacion }}
                {% if form.fecha_activacion.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.fecha_activacion.errors }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Información Técnica -->
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 1rem;">
                <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem;">
                    <i class="fas fa-network-wired"></i> Información Técnica
                </h3>
            </div>
            
            <div class="form-group">
                <label for="{{ form.ip_asignada.id_for_label }}">{{ form.ip_asignada.label }} (opcional)</label>
                {{ form.ip_asignada }}
                {% if form.ip_asignada.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.ip_asignada.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.mac_equipo.id_for_label }}">{{ form.mac_equipo.label }} (opcional)</label>
                {{ form.mac_equipo }}
                {% if form.mac_equipo.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.mac_equipo.errors }}
                    </div>
                {% endif %}
            </div>
            
            <!-- Notas -->
            <div class="form-group" style="grid-column: 1 / -1; margin-top: 1rem;">
                <h3 style="color: #667eea; margin-bottom: 1rem; border-bottom: 2px solid #f0f0f0; padding-bottom: 0.5rem;">
                    <i class="fas fa-sticky-note"></i> Notas
                </h3>
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.notas_instalacion.id_for_label }}">{{ form.notas_instalacion.label }} (opcional)</label>
                {{ form.notas_instalacion }}
                {% if form.notas_instalacion.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.notas_instalacion.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.notas_tecnicas.id_for_label }}">{{ form.notas_tecnicas.label }} (opcional)</label>
                {{ form.notas_tecnicas }}
                {% if form.notas_tecnicas.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.notas_tecnicas.errors }}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-actions" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #f0f0f0; display: flex; gap: 1rem; justify-content: flex-end;">
            <button type="submit" class="btn" style="min-width: 150px;">
                <i class="fas fa-save"></i> {% if instalacion %}Actualizar{% else %}Crear{% endif %} Instalación
            </button>
            <a href="{% if instalacion %}{% url 'instalaciones:instalacion_detail' instalacion.pk %}{% elif cliente_pre_seleccionado %}{% url 'clientes:cliente_detail' cliente_pre_seleccionado.pk %}{% else %}{% url 'instalaciones:instalacion_list' %}{% endif %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<style>
    .form-group {
        margin-bottom: 1rem;
    }
    
    .form-group label {
        display: block;
        margin-bottom: 0.5rem;
        font-weight: 600;
        color: #374151;
    }
    
    .form-group input[type="text"],
    .form-group input[type="number"],
    .form-group input[type="datetime-local"],
    .form-group select,
    .form-group textarea {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 6px;
        font-size: 1rem;
        transition: border-color 0.2s, box-shadow 0.2s;
    }
    
    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
        outline: none;
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group small {
        display: block;
        margin-top: 0.5rem;
    }
    
    h3 {
        font-size: 1.25rem;
        font-weight: 600;
    }
    
    h3 i {
        margin-right: 0.5rem;
    }
</style>

<script>
// Variables globales para búsqueda de clientes
let searchTimeout = null;
let selectedIndex = -1;
let resultados = [];

// Elementos del DOM
const clienteInput = document.getElementById('id_cliente');
const searchInput = document.getElementById('clienteSearchInput');
const resultsContainer = document.getElementById('clienteResults');
const selectedCard = document.getElementById('clienteSelectedCard');
const selectedName = document.getElementById('clienteSelectedName');
const selectedDetails = document.getElementById('clienteSelectedDetails');
const instalacionesPrevias = document.getElementById('instalacionesPrevias');
const instalacionesPreviasList = document.getElementById('instalacionesPreviasList');

// Buscar clientes
function buscarClientes(query) {
    if (query.length < 2) {
        resultsContainer.classList.remove('active');
        return;
    }
    
    resultsContainer.innerHTML = '<div class="searching"><i class="fas fa-spinner fa-spin"></i> Buscando...</div>';
    resultsContainer.classList.add('active');
    
    fetch(`{% url 'instalaciones:api_buscar_clientes' %}?q=${encodeURIComponent(query)}`)
        .then(response => response.json())
        .then(data => {
            resultados = data.clientes;
            selectedIndex = -1;
            
            if (resultados.length === 0) {
                resultsContainer.innerHTML = '<div class="no-results"><i class="fas fa-info-circle"></i> No se encontraron clientes</div>';
            } else {
                let html = '';
                resultados.forEach((cliente, index) => {
                    const badgeClass = cliente.estado.toLowerCase() === 'activo' ? 'badge-activo' : 
                                       cliente.estado.toLowerCase() === 'suspendido' ? 'badge-suspendido' : 'badge-inactivo';
                    html += `
                        <div class="cliente-result-item" data-index="${index}" onclick="selectCliente(${index})">
                            <div class="cliente-result-name">
                                ${cliente.nombre_completo}
                                <span class="cliente-result-badge ${badgeClass}">${cliente.estado}</span>
                            </div>
                            <div class="cliente-result-info">
                                <i class="fas fa-phone"></i> ${cliente.telefono}
                                ${cliente.email ? `&nbsp;|&nbsp; <i class="fas fa-envelope"></i> ${cliente.email}` : ''}
                                ${cliente.ciudad ? `&nbsp;|&nbsp; <i class="fas fa-map-marker-alt"></i> ${cliente.ciudad}` : ''}
                            </div>
                        </div>
                    `;
                });
                resultsContainer.innerHTML = html;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            resultsContainer.innerHTML = '<div class="no-results"><i class="fas fa-exclamation-triangle"></i> Error al buscar</div>';
        });
}

// Seleccionar cliente
function selectCliente(index) {
    const cliente = resultados[index];
    if (!cliente) return;
    
    // Actualizar campo oculto
    clienteInput.value = cliente.id;
    
    // Mostrar cliente seleccionado
    selectedName.textContent = cliente.nombre_completo;
    selectedDetails.innerHTML = `
        <i class="fas fa-phone"></i> ${cliente.telefono}
        ${cliente.email ? `&nbsp;|&nbsp; <i class="fas fa-envelope"></i> ${cliente.email}` : ''}
    `;
    
    // Ocultar buscador, mostrar seleccionado
    searchInput.style.display = 'none';
    searchInput.value = '';
    resultsContainer.classList.remove('active');
    selectedCard.classList.add('active');
    
    // Cargar instalaciones del cliente
    cargarInstalacionesCliente(cliente.id);
}

// Remover cliente seleccionado
function removeSelectedCliente() {
    clienteInput.value = '';
    selectedCard.classList.remove('active');
    instalacionesPrevias.classList.remove('active');
    searchInput.style.display = 'block';
    searchInput.value = '';
    searchInput.focus();
}

// Cargar instalaciones del cliente
function cargarInstalacionesCliente(clienteId) {
    if (!clienteId) {
        instalacionesPrevias.classList.remove('active');
        return;
    }
    
    fetch(`{% url 'instalaciones:api_instalaciones_cliente' 0 %}`.replace('0', clienteId))
        .then(response => response.json())
        .then(data => {
            if (data.error) {
                console.error('Error:', data.error);
                return;
            }
            
            if (data.instalaciones && data.instalaciones.length > 0) {
                let html = '';
                data.instalaciones.forEach(inst => {
                    html += `
                        <div class="instalacion-previa-item">
                            <div class="instalacion-previa-plan">
                                <i class="fas fa-wifi"></i> ${inst.plan_nombre}
                            </div>
                            <div class="instalacion-previa-info">
                                Estado: ${inst.estado} | 
                                Precio: $${inst.precio_mensual}/mes
                                ${inst.numero_contrato ? ` | Contrato: ${inst.numero_contrato}` : ''}
                                ${inst.fecha_solicitud ? ` | Fecha: ${inst.fecha_solicitud}` : ''}
                            </div>
                        </div>
                    `;
                });
                instalacionesPreviasList.innerHTML = html;
                instalacionesPrevias.classList.add('active');
            } else {
                instalacionesPrevias.classList.remove('active');
            }
        })
        .catch(error => {
            console.error('Error al cargar instalaciones:', error);
            instalacionesPrevias.classList.remove('active');
        });
}

// Navegar con teclado
function handleKeyNavigation(e) {
    const items = resultsContainer.querySelectorAll('.cliente-result-item');
    
    if (e.key === 'ArrowDown') {
        e.preventDefault();
        selectedIndex = Math.min(selectedIndex + 1, items.length - 1);
        updateSelectedItem(items);
    } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        selectedIndex = Math.max(selectedIndex - 1, 0);
        updateSelectedItem(items);
    } else if (e.key === 'Enter' && selectedIndex >= 0) {
        e.preventDefault();
        selectCliente(selectedIndex);
    } else if (e.key === 'Escape') {
        resultsContainer.classList.remove('active');
    }
}

function updateSelectedItem(items) {
    items.forEach((item, index) => {
        item.classList.toggle('selected', index === selectedIndex);
    });
    
    if (items[selectedIndex]) {
        items[selectedIndex].scrollIntoView({ block: 'nearest' });
    }
}

// Event listeners
document.addEventListener('DOMContentLoaded', function() {
    // === Búsqueda de clientes ===
    if (searchInput) {
        // Búsqueda con debounce
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                buscarClientes(this.value.trim());
            }, 200);
        });
        
        // Mostrar todas las opciones al enfocar
        searchInput.addEventListener('focus', function() {
            if (this.value.trim().length >= 2) {
                buscarClientes(this.value.trim());
            }
        });
        
        // Navegación con teclado
        searchInput.addEventListener('keydown', handleKeyNavigation);
    }
    
    // Si ya hay un cliente seleccionado (edición o pre-seleccionado)
    if (clienteInput && clienteInput.value) {
        searchInput.style.display = 'none';
        selectedCard.classList.add('active');
        // Cargar instalaciones del cliente si existe
        cargarInstalacionesCliente(clienteInput.value);
    }
    
    // Cerrar resultados al hacer clic fuera
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.cliente-search-container')) {
            resultsContainer.classList.remove('active');
        }
    });
    
    // === Funcionalidad del plan ===
    const planSelect = document.getElementById('id_plan');
    const planNombreInput = document.getElementById('id_plan_nombre');
    const velocidadDescargaInput = document.getElementById('id_velocidad_descarga');
    const velocidadSubidaInput = document.getElementById('id_velocidad_subida');
    const precioMensualInput = document.getElementById('id_precio_mensual');
    
    if (planSelect) {
        planSelect.addEventListener('change', function() {
            const planId = this.value;
            
            if (planId) {
                // Obtener datos del plan desde la API
                fetch(`{% url 'instalaciones:get_plan_data' 0 %}`.replace('0', planId))
                    .then(response => response.json())
                    .then(data => {
                        if (data.error) {
                            console.error('Error:', data.error);
                            return;
                        }
                        
                        // Llenar campos automáticamente
                        if (planNombreInput && !planNombreInput.value) {
                            planNombreInput.value = data.nombre;
                        }
                        if (velocidadDescargaInput) {
                            velocidadDescargaInput.value = data.velocidad_descarga;
                        }
                        if (velocidadSubidaInput && data.velocidad_subida) {
                            velocidadSubidaInput.value = data.velocidad_subida;
                        }
                        if (precioMensualInput) {
                            precioMensualInput.value = data.precio_mensual.toFixed(2);
                        }
                        
                        // Mostrar mensaje de confirmación
                        if (planNombreInput) {
                            planNombreInput.style.borderColor = '#10b981';
                            setTimeout(() => {
                                planNombreInput.style.borderColor = '';
                            }, 2000);
                        }
                    })
                    .catch(error => {
                        console.error('Error al obtener datos del plan:', error);
                    });
            }
        });
    }
});
</script>
{% endblock %}

