{% extends 'base.html' %}

{% block title %}{{ title }} - {{ sistema_config.nombre_empresa|default:"AdminiRed" }}{% endblock %}

{% block extra_css %}
<style>
    /* Estilos del buscador de clientes */
    .cliente-search-container {
        position: relative;
    }
    
    .cliente-search-input {
        width: 100%;
        padding: 0.75rem;
        padding-left: 2.5rem;
        border: 2px solid #e5e7eb;
        border-radius: 8px;
        font-size: 1rem;
        transition: all 0.3s;
    }
    
    .cliente-search-input:focus {
        outline: none;
        border-color: #10b981;
        box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
    }
    
    .cliente-search-icon {
        position: absolute;
        left: 0.75rem;
        top: 50%;
        transform: translateY(-50%);
        color: #9ca3af;
        pointer-events: none;
    }
    
    .cliente-results {
        position: absolute;
        top: 100%;
        left: 0;
        right: 0;
        background: white;
        border: 2px solid #e5e7eb;
        border-top: none;
        border-radius: 0 0 8px 8px;
        max-height: 300px;
        overflow-y: auto;
        z-index: 1000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        display: none;
    }
    
    .cliente-result-item {
        padding: 0.75rem;
        cursor: pointer;
        border-bottom: 1px solid #f3f4f6;
        transition: background-color 0.2s;
    }
    
    .cliente-result-item:hover {
        background-color: #f9fafb;
    }
    
    .cliente-result-item:last-child {
        border-bottom: none;
    }
    
    .info-box {
        background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
        border: 2px solid #10b981;
        border-radius: 12px;
        padding: 1.5rem;
        margin-bottom: 2rem;
    }
    
    .info-box h3 {
        color: #059669;
        margin-bottom: 0.75rem;
        font-size: 1.1rem;
    }
    
    .info-box ul {
        margin: 0.5rem 0;
        padding-left: 1.5rem;
        color: #065f46;
    }
    
    .info-box li {
        margin: 0.5rem 0;
    }
</style>
{% endblock %}

{% block content %}
<div class="section">
    <div class="section-header">
        <h2><i class="fas fa-receipt"></i> {{ title }}</h2>
        <a href="{% url 'pagos:pago_list' %}" class="btn btn-secondary">
            <i class="fas fa-arrow-left"></i> Volver a Lista
        </a>
    </div>
    
    <div class="info-box">
        <h3><i class="fas fa-info-circle"></i> Registro de Pago Manual</h3>
        <p style="color: #065f46; margin-bottom: 0.5rem;">
            Use este formulario para registrar pagos que el cliente realizó mediante depósito en tienda de conveniencia, transferencia bancaria u otro método offline.
        </p>
        <ul>
            <li>El pago se marcará automáticamente como <strong>"Pagado"</strong></li>
            <li>Es <strong>obligatorio</strong> proporcionar la referencia del comprobante o depósito</li>
            <li>La fecha de pago se establecerá automáticamente a la fecha/hora actual</li>
            <li>Puede adjuntar notas adicionales con información sobre el lugar donde se realizó el pago</li>
        </ul>
    </div>
    
    <form method="post" class="form-container">
        {% csrf_token %}
        
        <!-- Cliente -->
        <div class="form-group">
            <label for="id_cliente">{{ form.cliente.label }} <span style="color: #ef4444;">*</span></label>
            {% if cliente_pre_seleccionado %}
                <input type="text" value="{{ cliente_pre_seleccionado.nombre_completo }}" class="form-control" disabled>
                <input type="hidden" name="cliente" value="{{ cliente_pre_seleccionado.pk }}">
            {% else %}
                <div class="cliente-search-container">
                    <i class="fas fa-search cliente-search-icon"></i>
                    <input type="text" id="cliente-search" class="cliente-search-input" placeholder="Buscar cliente por nombre, teléfono o email..." autocomplete="off">
                    <div id="cliente-results" class="cliente-results"></div>
                </div>
                {{ form.cliente }}
                {% if form.cliente.errors %}
                    <div class="error-message">{{ form.cliente.errors }}</div>
                {% endif %}
            {% endif %}
        </div>
        
        <!-- Instalación (opcional) -->
        <div class="form-group">
            <label for="id_instalacion">{{ form.instalacion.label }}</label>
            {{ form.instalacion }}
            {% if form.instalacion.errors %}
                <div class="error-message">{{ form.instalacion.errors }}</div>
            {% endif %}
            <small class="form-text">Opcional: Seleccione la instalación relacionada si aplica</small>
        </div>
        
        <div class="form-row">
            <!-- Monto -->
            <div class="form-group">
                <label for="id_monto">{{ form.monto.label }} <span style="color: #ef4444;">*</span></label>
                <div style="position: relative;">
                    <span style="position: absolute; left: 0.75rem; top: 50%; transform: translateY(-50%); color: #6b7280; font-weight: 600;">$</span>
                    {{ form.monto }}
                </div>
                {% if form.monto.errors %}
                    <div class="error-message">{{ form.monto.errors }}</div>
                {% endif %}
            </div>
            
            <!-- Concepto -->
            <div class="form-group">
                <label for="id_concepto">{{ form.concepto.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.concepto }}
                {% if form.concepto.errors %}
                    <div class="error-message">{{ form.concepto.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-row">
            <!-- Período Mes -->
            <div class="form-group">
                <label for="id_periodo_mes">{{ form.periodo_mes.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.periodo_mes }}
                {% if form.periodo_mes.errors %}
                    <div class="error-message">{{ form.periodo_mes.errors }}</div>
                {% endif %}
            </div>
            
            <!-- Período Año -->
            <div class="form-group">
                <label for="id_periodo_anio">{{ form.periodo_anio.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.periodo_anio }}
                {% if form.periodo_anio.errors %}
                    <div class="error-message">{{ form.periodo_anio.errors }}</div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-row">
            <!-- Fecha de Vencimiento -->
            <div class="form-group">
                <label for="id_fecha_vencimiento">{{ form.fecha_vencimiento.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.fecha_vencimiento }}
                {% if form.fecha_vencimiento.errors %}
                    <div class="error-message">{{ form.fecha_vencimiento.errors }}</div>
                {% endif %}
            </div>
            
            <!-- Fecha de Pago -->
            <div class="form-group">
                <label for="id_fecha_pago">{{ form.fecha_pago.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.fecha_pago }}
                {% if form.fecha_pago.errors %}
                    <div class="error-message">{{ form.fecha_pago.errors }}</div>
                {% endif %}
                <small class="form-text">Fecha y hora en que se recibió el pago</small>
            </div>
        </div>
        
        <div class="form-row">
            <!-- Método de Pago -->
            <div class="form-group">
                <label for="id_metodo_pago">{{ form.metodo_pago.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.metodo_pago }}
                {% if form.metodo_pago.errors %}
                    <div class="error-message">{{ form.metodo_pago.errors }}</div>
                {% endif %}
            </div>
            
            <!-- Referencia de Pago -->
            <div class="form-group">
                <label for="id_referencia_pago">{{ form.referencia_pago.label }} <span style="color: #ef4444;">*</span></label>
                {{ form.referencia_pago }}
                {% if form.referencia_pago.errors %}
                    <div class="error-message">{{ form.referencia_pago.errors }}</div>
                {% endif %}
                <small class="form-text">Número de comprobante, referencia de depósito, número de transacción, etc.</small>
            </div>
        </div>
        
        <!-- Notas -->
        <div class="form-group">
            <label for="id_notas">{{ form.notas.label }}</label>
            {{ form.notas }}
            {% if form.notas.errors %}
                <div class="error-message">{{ form.notas.errors }}</div>
            {% endif %}
            <small class="form-text">Información adicional (ej: nombre de la tienda donde se realizó el depósito)</small>
        </div>
        
        <!-- Errores generales del formulario -->
        {% if form.non_field_errors %}
            <div class="error-message" style="margin-bottom: 1.5rem;">
                {{ form.non_field_errors }}
            </div>
        {% endif %}
        
        <div class="form-actions">
            <button type="submit" class="btn" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
                <i class="fas fa-save"></i> Registrar Pago
            </button>
            <a href="{% url 'pagos:pago_list' %}" class="btn btn-secondary">
                <i class="fas fa-times"></i> Cancelar
            </a>
        </div>
    </form>
</div>

<script>
// Búsqueda de clientes
const clienteSearch = document.getElementById('cliente-search');
const clienteResults = document.getElementById('cliente-results');
const clienteHidden = document.getElementById('id_cliente');
let searchTimeout;

clienteSearch.addEventListener('input', function() {
    clearTimeout(searchTimeout);
    const query = this.value.trim();
    
    if (query.length < 2) {
        clienteResults.style.display = 'none';
        return;
    }
    
    searchTimeout = setTimeout(() => {
        fetch(`{% url 'pagos:api_buscar_clientes' %}?q=${encodeURIComponent(query)}`)
            .then(response => response.json())
            .then(data => {
                clienteResults.innerHTML = '';
                if (data.clientes && data.clientes.length > 0) {
                    data.clientes.forEach(cliente => {
                        const item = document.createElement('div');
                        item.className = 'cliente-result-item';
                        item.innerHTML = `
                            <strong>${cliente.nombre_completo}</strong><br>
                            <small>${cliente.telefono}${cliente.email ? ' | ' + cliente.email : ''}</small>
                        `;
                        item.addEventListener('click', () => {
                            clienteHidden.value = cliente.id;
                            clienteSearch.value = cliente.nombre_completo;
                            clienteResults.style.display = 'none';
                            
                            // Cargar instalaciones del cliente
                            fetch(`{% url 'pagos:api_instalaciones_cliente' 0 %}`.replace('0', cliente.id))
                                .then(response => response.json())
                                .then(data => {
                                    const instalacionSelect = document.getElementById('id_instalacion');
                                    instalacionSelect.innerHTML = '<option value="">---------</option>';
                                    if (data.instalaciones) {
                                        data.instalaciones.forEach(inst => {
                                            const option = document.createElement('option');
                                            option.value = inst.id;
                                            option.textContent = `${inst.plan_nombre || 'Instalación #' + inst.id} - ${inst.estado}`;
                                            instalacionSelect.appendChild(option);
                                        });
                                    }
                                });
                        });
                        clienteResults.appendChild(item);
                    });
                    clienteResults.style.display = 'block';
                } else {
                    clienteResults.innerHTML = '<div class="cliente-result-item" style="color: #9ca3af;">No se encontraron clientes</div>';
                    clienteResults.style.display = 'block';
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
    }, 300);
});

// Cerrar resultados al hacer clic fuera
document.addEventListener('click', function(e) {
    if (!clienteSearch.contains(e.target) && !clienteResults.contains(e.target)) {
        clienteResults.style.display = 'none';
    }
});
</script>
{% endblock %}



