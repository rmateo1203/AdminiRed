{% extends 'base.html' %}
{% load static %}

{% block title %}Cambiar Contraseña del Portal{% endblock %}

{% block content %}
<div class="container" style="max-width: 800px; margin: 2rem auto;">
    <div class="card" style="background: white; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); padding: 2rem;">
        <h1 style="margin-bottom: 1.5rem; color: #333; display: flex; align-items: center; gap: 0.5rem;">
            <i class="fas fa-key"></i>
            Cambiar Contraseña del Portal
        </h1>
        
        {% if clientes|length == 1 %}
            <p style="margin-bottom: 1rem; color: #666;">
                Cambiar contraseña para: <strong>{{ clientes.0.nombre_completo }}</strong>
            </p>
            {% if clientes.0.usuario %}
                <p style="margin-bottom: 1.5rem; color: #666;">
                    Usuario: <strong>{{ clientes.0.usuario.username }}</strong>
                </p>
            {% else %}
                <div style="padding: 1rem; background: #fff3cd; border: 1px solid #ffc107; border-radius: 4px; margin-bottom: 1.5rem; color: #856404;">
                    <strong>⚠️ Advertencia:</strong> Este cliente no tiene usuario del portal. 
                    Debes crear un usuario primero.
                </div>
            {% endif %}
        {% else %}
            <p style="margin-bottom: 1rem; color: #666;">
                Cambiar contraseña para <strong>{{ clientes|length }} cliente(s)</strong> seleccionado(s):
            </p>
            <ul style="margin-bottom: 1.5rem; padding-left: 1.5rem; color: #666;">
                {% for cliente in clientes %}
                    <li style="margin-bottom: 0.5rem;">
                        <strong>{{ cliente.nombre_completo }}</strong>
                        {% if cliente.usuario %}
                            (Usuario: {{ cliente.usuario.username }})
                        {% else %}
                            <span style="color: #dc3545;">⚠️ Sin usuario</span>
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}
        
        <form method="post" action="{% url 'clientes:cambiar_password' cliente_ids=cliente_ids %}">
            {% csrf_token %}
            
            <div style="margin-bottom: 1.5rem;">
                <label for="nueva_password" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #333;">
                    Nueva contraseña:
                </label>
                <input 
                    type="password" 
                    name="nueva_password" 
                    id="nueva_password" 
                    required 
                    minlength="8"
                    class="form-control"
                    style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
                    placeholder="Mínimo 8 caracteres"
                    autocomplete="new-password"
                >
                <small style="color: #666; font-size: 0.875rem; margin-top: 0.25rem; display: block;">
                    La misma contraseña se aplicará a todos los clientes seleccionados.
                </small>
            </div>
            
            <div style="margin-bottom: 1.5rem;">
                <label for="confirmar_password" style="display: block; margin-bottom: 0.5rem; font-weight: 500; color: #333;">
                    Confirmar contraseña:
                </label>
                <input 
                    type="password" 
                    name="confirmar_password" 
                    id="confirmar_password" 
                    required 
                    minlength="8"
                    class="form-control"
                    style="width: 100%; padding: 0.75rem; border: 1px solid #ddd; border-radius: 4px; font-size: 1rem;"
                    placeholder="Repite la contraseña"
                    autocomplete="new-password"
                >
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button 
                    type="submit" 
                    class="btn"
                    style="flex: 1; padding: 0.75rem 1.5rem; background-color: var(--color-primario); color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer;"
                >
                    <i class="fas fa-save"></i> Cambiar Contraseña
                </button>
                <a 
                    href="{% url 'clientes:cliente_list' %}" 
                    class="btn btn-secondary"
                    style="flex: 1; padding: 0.75rem 1.5rem; background-color: #6c757d; color: white; text-decoration: none; border-radius: 4px; font-size: 1rem; text-align: center; display: flex; align-items: center; justify-content: center;"
                >
                    <i class="fas fa-times"></i> Cancelar
                </a>
            </div>
        </form>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.querySelector('form');
    const nuevaPassword = document.getElementById('nueva_password');
    const confirmarPassword = document.getElementById('confirmar_password');
    
    function validatePasswords() {
        if (nuevaPassword.value && confirmarPassword.value) {
            if (nuevaPassword.value !== confirmarPassword.value) {
                confirmarPassword.setCustomValidity('Las contraseñas no coinciden');
            } else {
                confirmarPassword.setCustomValidity('');
            }
        }
    }
    
    nuevaPassword.addEventListener('input', validatePasswords);
    confirmarPassword.addEventListener('input', validatePasswords);
    
    form.addEventListener('submit', function(e) {
        if (nuevaPassword.value.length < 8) {
            e.preventDefault();
            alert('La contraseña debe tener al menos 8 caracteres.');
            return false;
        }
        validatePasswords();
        if (!form.checkValidity()) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}

