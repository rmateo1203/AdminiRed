{% extends 'base.html' %}

{% block title %}{{ title }} - AdminiRed{% endblock %}

{% block content %}
<div class="section">
    <h2>{{ title }}</h2>
    
    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags == 'error' %}alert-danger{% elif message.tags == 'success' %}alert-success{% else %}alert-info{% endif %}">
                {{ message }}
            </div>
        {% endfor %}
    {% endif %}
    
    {% if form.non_field_errors %}
        <div class="alert alert-danger">
            <strong>Errores en el formulario:</strong>
            <ul style="margin: 0.5rem 0 0 1.5rem;">
                {% for error in form.non_field_errors %}
                    <li>{{ error }}</li>
                {% endfor %}
            </ul>
        </div>
    {% endif %}
    
    <form method="post">
        {% csrf_token %}
        
        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1.5rem;">
            <div class="form-group">
                <label for="{{ form.nombre.id_for_label }}">{{ form.nombre.label }}</label>
                {{ form.nombre }}
                {% if form.nombre.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.nombre.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.apellido1.id_for_label }}">{{ form.apellido1.label }}</label>
                {{ form.apellido1 }}
                {% if form.apellido1.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.apellido1.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.apellido2.id_for_label }}">{{ form.apellido2.label }} (opcional)</label>
                {{ form.apellido2 }}
                {% if form.apellido2.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.apellido2.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.telefono.id_for_label }}">{{ form.telefono.label }}</label>
                <div style="position: relative;">
                    {{ form.telefono }}
                    <span id="telefono-status" class="validation-status" style="display: none;"></span>
                </div>
                <div id="telefono-feedback" class="validation-feedback" style="display: none;"></div>
                {% if form.telefono.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.telefono.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.email.id_for_label }}">
                    {{ form.email.label }}
                    {% if form.email.field.required %}<span style="color: #ef4444;">*</span>{% endif %}
                </label>
                <div style="position: relative;">
                    {{ form.email }}
                    <span id="email-status" class="validation-status" style="display: none;"></span>
                </div>
                <div id="email-feedback" class="validation-feedback" style="display: none;"></div>
                {% if form.email.help_text %}
                    <small style="color: #6b7280; font-size: 0.875rem; display: block; margin-top: 0.25rem;">
                        {{ form.email.help_text }}
                    </small>
                {% endif %}
                {% if form.email.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.email.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.estado_cliente.id_for_label }}">{{ form.estado_cliente.label }}</label>
                {{ form.estado_cliente }}
                {% if form.estado_cliente.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.estado_cliente.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.direccion.id_for_label }}">{{ form.direccion.label }}</label>
                {{ form.direccion }}
                {% if form.direccion.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.direccion.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.ciudad.id_for_label }}">{{ form.ciudad.label }}</label>
                {{ form.ciudad }}
                {% if form.ciudad.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.ciudad.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.estado.id_for_label }}">{{ form.estado.label }}</label>
                {{ form.estado }}
                {% if form.estado.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.estado.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group">
                <label for="{{ form.codigo_postal.id_for_label }}">{{ form.codigo_postal.label }} (opcional)</label>
                {{ form.codigo_postal }}
                {% if form.codigo_postal.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.codigo_postal.errors }}
                    </div>
                {% endif %}
            </div>
            
            <div class="form-group" style="grid-column: 1 / -1;">
                <label for="{{ form.notas.id_for_label }}">{{ form.notas.label }} (opcional)</label>
                {{ form.notas }}
                {% if form.notas.errors %}
                    <div style="color: #ef4444; font-size: 0.9rem; margin-top: 0.5rem;">
                        {{ form.notas.errors }}
                    </div>
                {% endif %}
            </div>
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn">üíæ Guardar</button>
            {% if cliente %}
                <a href="{% url 'clientes:cliente_detail' cliente.pk %}" class="btn btn-secondary">Cancelar</a>
            {% else %}
                <a href="{% url 'clientes:cliente_list' %}" class="btn btn-secondary">Cancelar</a>
            {% endif %}
        </div>
    </form>
</div>

<style>
.validation-status {
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 1.2rem;
    pointer-events: none;
}

.validation-status.valid {
    color: #10b981;
}

.validation-status.invalid {
    color: #ef4444;
}

.validation-status.checking {
    color: #6b7280;
    animation: spin 1s linear infinite;
}

@keyframes spin {
    from { transform: translateY(-50%) rotate(0deg); }
    to { transform: translateY(-50%) rotate(360deg); }
}

.validation-feedback {
    margin-top: 0.5rem;
    font-size: 0.875rem;
    padding: 0.5rem;
    border-radius: 4px;
}

.validation-feedback.valid {
    color: #10b981;
    background-color: #d1fae5;
}

.validation-feedback.invalid {
    color: #ef4444;
    background-color: #fee2e2;
}

.validation-feedback.checking {
    color: #6b7280;
    background-color: #f3f4f6;
}

.form-group input:focus + .validation-status {
    display: inline-block;
}
</style>

<script>
(function() {
    'use strict';
    
    // Obtener el ID del cliente si estamos editando
    const clienteId = {% if cliente %}{{ cliente.pk }}{% else %}null{% endif %};
    
    // Configuraci√≥n de validaci√≥n
    const validationConfig = {
        email: {
            field: document.getElementById('{{ form.email.id_for_label }}'),
            status: document.getElementById('email-status'),
            feedback: document.getElementById('email-feedback'),
            minLength: 5,
            debounceTime: 500
        },
        telefono: {
            field: document.getElementById('{{ form.telefono.id_for_label }}'),
            status: document.getElementById('telefono-status'),
            feedback: document.getElementById('telefono-feedback'),
            minLength: 9,
            debounceTime: 500
        }
    };
    
    // Timeouts para debounce
    const timeouts = {};
    
    // Funci√≥n para validar un campo
    function validateField(campo, config) {
        const valor = config.field.value.trim();
        
        // Si el campo est√° vac√≠o, ocultar feedback
        if (!valor) {
            config.status.style.display = 'none';
            config.feedback.style.display = 'none';
            return;
        }
        
        // Validaci√≥n de longitud m√≠nima
        if (valor.length < config.minLength) {
            config.status.style.display = 'none';
            config.feedback.style.display = 'none';
            return;
        }
        
        // Mostrar estado de carga
        config.status.style.display = 'inline-block';
        config.status.className = 'validation-status checking';
        config.status.textContent = '‚ü≥';
        config.feedback.style.display = 'block';
        config.feedback.className = 'validation-feedback checking';
        config.feedback.textContent = 'Verificando...';
        
        // Construir URL
        const url = `{% url 'clientes:cliente_verificar_duplicado' %}?campo=${campo}&valor=${encodeURIComponent(valor)}${clienteId ? '&cliente_id=' + clienteId : ''}`;
        
        // Hacer petici√≥n AJAX
        fetch(url, {
            method: 'GET',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
            },
            credentials: 'same-origin'
        })
        .then(response => response.json())
        .then(data => {
            if (data.valido) {
                // Campo v√°lido
                config.status.className = 'validation-status valid';
                config.status.textContent = '‚úì';
                config.feedback.className = 'validation-feedback valid';
                config.feedback.textContent = data.mensaje;
                config.field.style.borderColor = '#10b981';
            } else {
                // Campo inv√°lido
                config.status.className = 'validation-status invalid';
                config.status.textContent = '‚úó';
                config.feedback.className = 'validation-feedback invalid';
                config.feedback.textContent = data.mensaje;
                config.field.style.borderColor = '#ef4444';
            }
        })
        .catch(error => {
            console.error('Error en validaci√≥n:', error);
            config.status.style.display = 'none';
            config.feedback.style.display = 'none';
            config.field.style.borderColor = '';
            // No bloquear el env√≠o si hay error en la validaci√≥n AJAX
            // El servidor validar√° de todas formas
        });
    }
    
    // Inicializar validaci√≥n para cada campo
    Object.keys(validationConfig).forEach(campo => {
        const config = validationConfig[campo];
        
        if (!config.field) return;
        
        // Validar al perder el foco
        config.field.addEventListener('blur', function() {
            validateField(campo, config);
        });
        
        // Validar mientras escribe (con debounce)
        config.field.addEventListener('input', function() {
            // Limpiar timeout anterior
            if (timeouts[campo]) {
                clearTimeout(timeouts[campo]);
            }
            
            // Establecer nuevo timeout
            timeouts[campo] = setTimeout(() => {
                validateField(campo, config);
            }, config.debounceTime);
        });
        
        // Limpiar validaci√≥n al enfocar
        config.field.addEventListener('focus', function() {
            if (timeouts[campo]) {
                clearTimeout(timeouts[campo]);
            }
        });
    });
    
    // Validar antes de enviar el formulario
    const form = document.querySelector('form');
    if (form) {
        form.addEventListener('submit', function(e) {
            let hasErrors = false;
            let errorMessages = [];
            
            // Validar campos requeridos
            const emailField = document.getElementById('{{ form.email.id_for_label }}');
            if (emailField && !emailField.value.trim()) {
                hasErrors = true;
                errorMessages.push('El correo electr√≥nico es requerido.');
                emailField.style.borderColor = '#ef4444';
                if (!emailField.nextElementSibling || !emailField.nextElementSibling.classList.contains('validation-status')) {
                    // Mostrar error visual
                    emailField.style.borderWidth = '2px';
                }
            } else if (emailField && emailField.value.trim()) {
                // Si tiene valor, verificar que no tenga error de validaci√≥n
                const emailFeedback = document.getElementById('email-feedback');
                if (emailFeedback && emailFeedback.classList.contains('invalid')) {
                    hasErrors = true;
                    errorMessages.push(emailFeedback.textContent || 'El correo electr√≥nico tiene errores.');
                }
            }
            
            const telefonoField = document.getElementById('{{ form.telefono.id_for_label }}');
            if (telefonoField && !telefonoField.value.trim()) {
                hasErrors = true;
                errorMessages.push('El tel√©fono es requerido.');
                telefonoField.style.borderColor = '#ef4444';
                telefonoField.style.borderWidth = '2px';
            } else if (telefonoField && telefonoField.value.trim()) {
                // Si tiene valor, verificar que no tenga error de validaci√≥n
                const telefonoFeedback = document.getElementById('telefono-feedback');
                if (telefonoFeedback && telefonoFeedback.classList.contains('invalid')) {
                    hasErrors = true;
                    errorMessages.push(telefonoFeedback.textContent || 'El tel√©fono tiene errores.');
                }
            }
            
            // Validar otros campos requeridos
            const nombreField = document.getElementById('{{ form.nombre.id_for_label }}');
            if (nombreField && !nombreField.value.trim()) {
                hasErrors = true;
                errorMessages.push('El nombre es requerido.');
                nombreField.style.borderColor = '#ef4444';
                nombreField.style.borderWidth = '2px';
            }
            
            const apellido1Field = document.getElementById('{{ form.apellido1.id_for_label }}');
            if (apellido1Field && !apellido1Field.value.trim()) {
                hasErrors = true;
                errorMessages.push('El primer apellido es requerido.');
                apellido1Field.style.borderColor = '#ef4444';
                apellido1Field.style.borderWidth = '2px';
            }
            
            const direccionField = document.getElementById('{{ form.direccion.id_for_label }}');
            if (direccionField && !direccionField.value.trim()) {
                hasErrors = true;
                errorMessages.push('La direcci√≥n es requerida.');
                direccionField.style.borderColor = '#ef4444';
                direccionField.style.borderWidth = '2px';
            }
            
            const ciudadField = document.getElementById('{{ form.ciudad.id_for_label }}');
            if (ciudadField && !ciudadField.value.trim()) {
                hasErrors = true;
                errorMessages.push('La ciudad es requerida.');
                ciudadField.style.borderColor = '#ef4444';
                ciudadField.style.borderWidth = '2px';
            }
            
            const estadoField = document.getElementById('{{ form.estado.id_for_label }}');
            if (estadoField && !estadoField.value.trim()) {
                hasErrors = true;
                errorMessages.push('El estado es requerido.');
                estadoField.style.borderColor = '#ef4444';
                estadoField.style.borderWidth = '2px';
            }
            
            if (hasErrors) {
                e.preventDefault();
                // Mostrar mensaje con errores espec√≠ficos
                const errorMsg = errorMessages.length > 0 
                    ? 'Por favor, corrige los siguientes errores:\n\n' + errorMessages.join('\n')
                    : 'Por favor, corrige los errores antes de enviar el formulario.';
                alert(errorMsg);
                // Scroll al primer campo con error
                const firstErrorField = document.querySelector('input[style*="border-color: rgb(239, 68, 68)"], textarea[style*="border-color: rgb(239, 68, 68)"]');
                if (firstErrorField) {
                    firstErrorField.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    setTimeout(() => firstErrorField.focus(), 300);
                }
                return false;
            }
            
            // Si no hay errores, permitir el env√≠o (el servidor validar√° de todas formas)
            return true;
        });
    }
})();
</script>
{% endblock %}


